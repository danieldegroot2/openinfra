---
title: "Transport Infrastructure Data Packs"
author: "James Hulse"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Transport Infrastructure Data Packs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Packs

This vignette covers the recategorisation of OpenStreetMap (OSM) infrastructure data into the openinfra transport infrastructure data packs.
<br><br>
To view the current publication of our data packs, please see the Openinfra GitHub repository releases page [here](https://github.com/udsleeds/openinfra/releases). 
<br><br>
The transport infrastructure data packs contain OSM infrastructure data for a given Local Authority District (LAD), as defined by the following polygons for [UK LADs](https://github.com/udsleeds/openinfra/blob/main/data-small/lads_joined_2021.geojson). 
<br><br>
Whilst these LADs are currently being used to define the spatial area covered by each infrastructure data pack, any new set of updated boundaries (as a geojson file) can also be used to create the transport infrastructure data packs. 
<br><br>

The LADs can be seen below: <br>

```{r, echo=FALSE, include=TRUE, out.width="650px"}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/LADs_of_the_UK_new.html", height = "650px")
```

## Current Data Pack Visualisation Examples

<br><br>
This sections visualises the data pack outputs generated by the openinfra functions that are described in detail below.

The current example data pack outputs for a 2km circular radius about "Leeds" City Centre: <br><br>
-- Cleaned road descriptions <br>
-- Legally cyclable network <br>
-- Legally walkable network <br>
-- Presence of lighting network <br>
-- Cleaned maximum speed values <br>
-- Presence of cycle crossings <br>
-- Presence of cycle parking <br>
-- Recategorised road names <br>
<br><br>

### Default OSM Highways

Please note that a 2Km circular buffer has been applied to the data so that the map can be hosted on this website. (max size 25Mb)<br>
As can be seen, the default network has a variety of `highway` values and is rather confusing to the uninitiated OSM user. 
<br>
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/deault_OSM_highways.html", height = "650px")
```
<br><br>

### Recategorised Road Descriptions
The recategorised road descriptions are more interpenetrate and meaningful than the default OSM highway values.

```{r visualisation_frame, out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/road_desc_map.html", height = "650px")
```
As can be seen - the OSM highways recategorised to road descriptions are much easier to visualise and insightful than all OSM highway values.
<br><br>

### Recategorised Cyclable Ways
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/active_cycle_map.html", height = "650px")
```
This visualisation shows the ways that cyclist legally have a right to access and use - note that this does not imply a "friendly" or "super safe" route, more that cyclists can use such ways if required.
<br><br>
An example application of this dataset could be highlighting the most likely roads that will be used by cyclists when switching from (intermittent) dedicated cycling infrastructure.

<br><br>

### Recategorised Walkable Ways
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/active_walk_map.html", height = "650px")
```

Much like the cyclable ways visualisation above, this visualisation shows ways that pedestrians legally have a right of way on. It does not assess or indicate any "friendliness" or "scenic-ness" of a way.
<br><br>

### Recategorised Presence of Street Lighting
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/is_lit_map.html", height = "650px")
```
Note that a value of `maybe` implies the lack of data to distinguish between `"yes"` or `"no"`.
<br><br>
Such information may be utilised to assess routes for safe active travel after dark. Likewise, complimented with Origin Destination (OD) data, one may identify active travel routes along high active travel traffic ways and implement lighting (if not present) to increase the safety of such routes after dark.

<br><br>

### Cleaned Maximum Speeds (UK)
```{r vis_frame, out.width="100%", echo=FALSE, include=TRUE}
#TODO: Update this plot - should not be inferring "missing data", rather assumed to be standard speedlimit for specific road type. 
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/clean_maxspeed_map.html", height = "650px")
```
Recategorised UK maximum road speed values. Based on the official [UK speed limits](https://www.gov.uk/speed-limits).
<br><br>
Note that the potential lack of coverage for the maxspeed tag is due to the fact that this tag is usually not explicitly adeed, except where it is an exceptional value. See [#147](https://github.com/udsleeds/openinfra/issues/147) for more context. 
<br><br>

### Presence of Cycle Crossings
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/cycle_crossings_map.html", height = "650px")
```
Identifies the presence of cycle crossings based on OSM data.
<br><br>

### Presence of Cycle Parking
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/cycle_parking_map.html", height = "650px")
```
Identifies the presence of cycle parking facilities based on OSM data.
<br><br>

### Recategorised Road Names
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/road_namesmap.html", height = "650px")
```
Recategorises OSM to provide more descriptive road names useful for discussion and targeted analysis. 
<br><br>
For example, [`osm_id:23200835`](https://www.openstreetmap.org/way/23200835) is less useful as a name than, `Lovell Park Road`
<br><br>

### Dedicated Cycling Infrastructure 
```{r out.width="100%", echo=FALSE, include=TRUE}
knitr::include_url("https://udsleeds.github.io/openinfraresults/tmap/assets/cycle_infra_map.html", height = "650px")
```
This function identifies the type of cycling infrastructure, with respect to the level of separation from carriageways, from OSM data. 
Such infrastructure consists of on carriageway infrastructure (cycling lanes, mixed traffic, shared busway/lanes) and protected infrastructure (cycle tracks and ways, stepped cycleways, kerb separated cycleways) where _protected_ implies some form of physical separation from the carriageway. 

## Data Pack Production Workflow

The English data pack outputs, with examples visualised above, are produced using the following, reproducible, workflow: 

- **1.** Download OSM data file for entirety of England <br><br>
- **2.** For each [LAD](https://udsleeds.github.io/openinfra/articles/regions.html#interactive-map-of-local-authorities) polygon, get the OSM points & lines data from the previously downloaded England file & save each LAD default points lines network locally <br><br>
- **3.** For each LAD points & lines network saved locally, load the network and apply the openinfra functions, recategorising the OSM data <br><br>
- **4.** Save the newly created points & lines data packs locally, before uploading to GitHub releases <br><br>
- **5.** Repeat **2 - 4** for each LAD within England

The workflow described above is contained within the [create_data_packs.R](https://github.com/udsleeds/openinfra/blob/main/code/create_data_packs.R) script. <br><br>
For ease of use, and segmenting long computation times, the above script has been split in two - [create_LAD_networks.R](https://github.com/udsleeds/openinfra/blob/main/code/create_LAD_networks.R) performing steps 1-2, and [create_upload_data_packs.R](https://github.com/udsleeds/openinfra/blob/main/code/create_upload_data_packs.R) for steps 3-4.

## Data Pack Column Definitions

This section defines the column names contained within each LAD data pack added by the [openinfra](https://udsleeds.github.io/openinfra/reference/index.html) functions.

|column name|column description|
|-----------|------------------|
|openinfra_cycle|Indicates if an OSM way is legally usable by cyclists <br><br> Note: this does not assess any "qualities" of a way (such as quietness, traffic flows etc.)|
|openinfra_walk|Indicates if an OSM way is legally usable by pedestrians <br><br> Note: this does not assess any "qualities" of a way (such as quietness, traffic flows etc.)|
|openinfra_cycle_parking|Identifies bicycle parking places from OSM data `amenity` tag|
|openinfra_maxspeed|Reclassified default OSM `maxspeed` column values to be compliant with current [UK speed limits](https://www.gov.uk/speed-limits)|
|openinfra_cycle_crossings|Identifies OSM ways used specifically for cycles to cross carriageways|
|openinfra_cycle_infra|Reclassifies default OSM data to identify the 'high-level' type of protection provided by dedicated cycling infrastructure, such as: <br><br>Mixed Traffic (=< 20 mph) - _no protection_,<br><br> Cycle Lanes (mandatory & advisory) - _legal protection_,<br><br> Protected Cycling Spaces - _physical protection_, <br><br> including: stepped cycleways, kerb separated cycleways, cycle tracks, etc.|
|openinfra_is_lit|Identifies if an OSM way has lighting present or not, or if there is a lack of data to accurately assess ("maybe")|
|openinfra_road_class|Reclassifies default OSM `highway` values to relevant UK highway classifications, with modifications used by [Chan and Cooper](https://www.nature.com/articles/s41598-019-55669-8)|
|openinfra_road_names|Identifies the road name and reference (where available) of OSM ways and combines these to be more informative.<br> i.e. `osm_id=4004413` --> Headingly Lane, A660|

## Example Data Pack Production - Leeds

Here we cover a reproducible example of the creation of a transport infrastructure data pack from OSM data retrieved using [`osmextract`](https://github.com/ropensci/osmextract), the outputs of which are visualised above. 


<br><br>
This example concerns the LAD of Leeds, UK. <br>
Note that a 2km circular buffer has been applied (centered at Long, Lat coords (-1.548567, 53.801277)) to reduce filesizes of the visualisations above.
<br><br>

### Getting Data
```{r download_data}
# Data downloaded through osmextract as shown below: 

#total_place = osmextract::oe_get(
#  place = "Leeds",
#  provider = "bbbike",
#  layer = "lines",
#  never_skip_vectortranslate = TRUE,
#  force_download = TRUE,
#  quiet = FALSE,
#  extra_tags = c("foot", "bicycle", "access", "service", "maxspeed", "oneway",
#                  "kerb", "footway", "sidewalk", "cycleway", "segregated", 
#                  "highway", "crossing", "lit", "tactile_paving", "surface", 
#                  "smoothness", "width", "est_width", "lit_by_led", "ref", 
#                  "amenity")
#)

# For reproduciblity you may chose to use the example dataset from our releases.
# You can create your own data using the oe_get() function above.
leeds_lines_network = sf::read_sf("https://github.com/udsleeds/openinfra/releases/download/0.4.2/leeds_lines_network.geojson")
leeds_points_network = sf::read_sf("https://github.com/udsleeds/openinfra/releases/download/0.4.2/leeds_points_network.geojson")
```

<br><br>

### Applying Openinfra Functions - Adding Value 
```{r function_application, eval=FALSE}
# First we apply relevant functions to the "lines" (roads, paths, etc.) layer 
leeds_lines_datapack = oi_active_cycle(leeds_lines_network)
leeds_lines_datapack = oi_active_walk(leeds_lines_datapack)
leeds_lines_datapack = oi_clean_maxspeed_uk(leeds_lines_datapack)
leeds_lines_datapack = oi_cycle_crossings(leeds_lines_datapack)
leeds_lines_datapack = oi_cycle_separation(leeds_lines_datapack)
leeds_lines_datapack = oi_is_lit(leeds_lines_datapack)
leeds_lines_datapack = oi_recode_road_class(leeds_lines_datapack)
leeds_lines_datapack = oi_road_names(leeds_lines_datapack)

# Now we create points data packs
leeds_points_datapack = oi_bicycle_parking(leeds_points_network)

```
<br><br>

### Selecting Relevant Columns for Data Pack
```{r, create_data_pack, eval=FALSE}
# Select relevant lines columns
leeds_lines_datapack = leeds_lines_datapack %>% dplyr::select(c(
 "osm_id", "highway", matches(match = "openinfra_|im_")))

# Append geometry as final column - good {sf} practice.
leeds_lines_datapack = sf::st_sf(
  leeds_lines_datapack %>% sf::st_drop_geometry(),
  geometry = leeds_lines_datapack$geometry)

# Select relevant points columns
leeds_points_datapack = leeds_points_datapack %>% dplyr::select(c(
  "osm_id", matches(match="openinfra_|im_")))

# Append geometry as final column - good {sf} practice.
leeds_points_datapack = sf::st_sf(
  leeds_points_datapack %>% sf::st_drop_geometry(),
  geometry = leeds_points_datapack$geometry)

```

### Example visualisation
```{r visualise_example_pack}
library(dplyr)

# Get data for cell
leeds_points_datapack = sf::read_sf("https://github.com/udsleeds/openinfra/releases/download/0.4.2/leeds_points_datapack.geojson")
# Remove NA 
leeds_points_datapack = leeds_points_datapack %>% dplyr::filter(! is.na(openinfra_cycle_parking)) 

#Visualise Data
tmap::tmap_mode("view")
tmap::tm_shape(leeds_points_datapack) + 
  tmap::tm_bubbles(col = "openinfra_cycle_parking", size=0.1)

```

This concludes the reproducible example creation of the transport infrastructure data packs.
<br><br>
Below we see how each of the openinfra functions has been defined, thus the processing steps applied to OSM data in data pack creation. 
<br><br>

## Data Packs: openinfra Function Definitions

The openinfra package functions used to create the transport infrastructure data packs have documentation available [here](https://udsleeds.github.io/openinfra/reference/index.html). The source code for each function can be found in project [GitHub R/ directory](https://github.com/udsleeds/openinfra/tree/main/R).